namespace OOO7_TRAIN
{
    internal class Program
    {
        static void Main(string[] args)
        {
            RailwayStation railwayStation = new RailwayStation();

            railwayStation.Work();
        }
    }

    class Carriage
    {
        public int SeatsAmount { get; private set; } = 54;
    }

    class Train
    {
        private List<Carriage> _carriages = new List<Carriage>();
        
        public Train(string departurePoint, string arrivingPoint, int passengersAmount, int number)
        {
            DeparturePoint = departurePoint;
            ArrivingPoint = arrivingPoint;
            PassengersAmount = passengersAmount;
            Number = number;
            _carriages = Fill();
        }

        public string DeparturePoint { get; private set; }
        public string ArrivingPoint { get; private set; }
        public int PassengersAmount {  get; private set; }
        public int Number { get; private set; }
        public bool IsSent { get; private set; } = false;


        public List<Carriage> Fill()
        {
            List<Carriage> carriages = new List<Carriage>();
            int passengersLeft = PassengersAmount;

            while(passengersLeft > 0)
            {
                Carriage carriage = new Carriage();

                carriages.Add(carriage);

                passengersLeft -= carriage.SeatsAmount;
            }

            return carriages;
        }

        public void ShowInfo()
        {
            if (IsSent)
            {
                Console.ForegroundColor = ConsoleColor.Green;
            }
            else
            {
                Console.ForegroundColor= ConsoleColor.Yellow;
            }

            Console.WriteLine($"{Number} {DeparturePoint} - {ArrivingPoint}. {_carriages.Count} вагонов / {PassengersAmount} пассажиров");

            Console.ResetColor();
        }

        public void SendTrain()
        {
            IsSent = true;
        }
    }

    class RailwayService
    {
        private List<string> _cities = new List<string>() { "Санкт-Петербург", "Москва", "Сочи", "Казань", "Мурманск", "Великий Новгрод" };

        public int GetPassengers()
        {
            Random random = new Random();
            return random.Next(0, int.MaxValue);
        }

        public void ChooseCities(out string departureCity, out string arrivingCity)
        {
            departureCity = GetCity("Введите город отправления:");

            _cities.Remove(departureCity);

            Console.Clear();

            arrivingCity = GetCity("Введите город прибытия:");
            
            Console.Clear();
        }

        private string GetCity(string text)
        {
            ShowCities();

            int userInput = UserUtils.TryParse(text);

            return _cities[userInput];
        }

        private void ShowCities()
        {
            for (int i = 0; i < _cities.Count; i++)
            {
                Console.WriteLine($"{i} {_cities[i]}");
            }
        }
    }

    class RailwayStation
    {
        private int _trainNumber = 0;
        private List<Train> _trains = new List<Train>();

        public void Work()
        {
            const ConsoleKey CommandExit = ConsoleKey.Escape;
            bool isWork = true;

            while (isWork)
            {
                Console.Clear();

                ShowTrains();

                Console.WriteLine($"Для завершения работы нажмите {CommandExit}\nДля продолжения работы нажмите любую другую клавишу.") ;

                ConsoleKeyInfo key = Console.ReadKey();

                if(key.Key == CommandExit)
                {
                    isWork = false;
                    break;
                }

                Console.Clear();
                Console.SetCursorPosition(0, 0);
                Console.WriteLine("Сформировать поезд:");
                Console.ReadKey();

                Train train = FormTrain();

                _trains.Add(train);

                Console.Clear();

                ShowTrains();

                Console.SetCursorPosition(0, 0);
                Console.WriteLine("Отправить поезд:");
                Console.ReadKey();

                train.SendTrain();
            }

            Console.Clear();
            Console.WriteLine("\tРабота завершена");
            Console.ReadKey();
        }

        private void ShowTrains()
        {
            int boardPositionX = 60;
            Console.SetCursorPosition(boardPositionX, 0);

            Console.WriteLine("Список поездов:");

            for (int i = 0; i < _trains.Count; i++)
            {
                Console.SetCursorPosition(boardPositionX, i + 1);

                _trains[i].ShowInfo();
            }
        }

        private Train FormTrain()
        {
            string departureCity;
            string arrivingCity;
            int passengersAmount;

            RailwayService railwayService = new RailwayService();

            railwayService.ChooseCities(out departureCity, out arrivingCity);

            passengersAmount = railwayService.GetPassengers();

            Train train = new Train(departureCity, arrivingCity, passengersAmount, _trainNumber);

            _trainNumber++;

            return train;
        }
    }

    class UserUtils
    {
        public static int TryParse(string text)
        {
            int parsedNumber;

            Console.Write(text);
            string userInput = Console.ReadLine();
            bool isNumber = int.TryParse(userInput, out parsedNumber);

            return parsedNumber;
        }
    }
}
