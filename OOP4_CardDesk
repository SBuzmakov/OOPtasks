using System.Numerics;
using System.Reflection.Metadata.Ecma335;

namespace OOP4_CardDeck
{
    internal class Program
    {
        static void Main(string[] args)
        {
            bool isWork = true;

            while (isWork)
            {
                Player player = new Player();
                Player enemy = new Player("Оппонент");
                Game21 game = new Game21(player, enemy);

                game.Play();

                isWork = CheckExitMenu();

                Console.Clear();
            }

            Console.WriteLine("good luck!");
            Console.ReadKey(true);
        }

        static bool CheckExitMenu()
        {
            const ConsoleKey PressEscape = ConsoleKey.Escape;

            Console.WriteLine($"\n\nВыйти из игры?\n\n\tклавиша {PressEscape} - выйти из игры. \n\nДля продолжения - остальные клавиши.");

            ConsoleKeyInfo charKey = Console.ReadKey(true);

            bool isESCPressed = charKey.Key == PressEscape ? false: true;
            
            return isESCPressed;
        }      
    }

    class Game21
    {
        private Dictionary<string, int> _cardsValues;
        private Player _player;
        private Player _enemy;
        private List<Card> _mixedDeck;
        private int _scoreLimit = 21;
        private int _dangerScore = 11;
        private int _randomRange = 2;
        private bool _isPlaying = true;

        public Game21(Player player, Player enemy)
        {
            _enemy = enemy;
            _player = player;

            _mixedDeck = new Deck36Cards().Mix();

            _cardsValues = new Dictionary<string, int>()
            {
                { "6", 6 },
                { "7", 7 },
                { "8", 8 },
                { "9", 9 },
                { "10", 10 },
                { "J", 2 },
                { "Q", 3 },
                { "K", 4 },
                { "A", 11 }
            };
        }

        public void Play()
        {
            PrintRules();

            Console.ReadKey();

            while (_isPlaying)
            {
                _player.ShowHand();

                ControlPlaying();

                DoEnemyTurn();

                CalculateScore(_player);

                CalculateScore(_enemy);

                SwitchScoreOverdone(_player);

                SwitchScoreOverdone(_enemy);

                GetResult();

                Console.Clear();
            }
        }

        private void PrintRules()
        {
            Console.WriteLine($"Наберите не больше {_scoreLimit} очка. Колода {_mixedDeck.Count} карт. \nКоличество очков за карты: \n");

            foreach (KeyValuePair<string, int> card in _cardsValues)
            {
                Console.WriteLine($"карта {card.Key} - {card.Value} очков");
            }
        }

        private void DoTurn()
        {
            if (_player.CanTakeCard)
            {
                _player.TakeCardToHand(_mixedDeck[0]);

                _mixedDeck.RemoveAt(0);

                Console.WriteLine("Вы взяли карту.");
                Console.ReadKey(true);
            }
        }

        private void DoEnemyTurn()
        {
            int enemyDecision = UserUtils.GenerateRandomNumber(0, _randomRange);

            if (_enemy.CanTakeCard && _enemy._score >= _dangerScore && enemyDecision == 0 || _enemy.CanTakeCard && _enemy._score == _scoreLimit)
            {
                _enemy.BanTurn();
            }
            else if (_enemy.CanTakeCard)
            {
                _enemy.TakeCardToHand(_mixedDeck[0]);

                _mixedDeck.RemoveAt(0);

                Console.WriteLine("Оппонент взял карту.");
                Console.ReadKey(true);
            }
        }

        private void ControlPlaying()
        {
            const ConsoleKey PressY = ConsoleKey.Y;
            const ConsoleKey PressN = ConsoleKey.N;
            const ConsoleKey PressE = ConsoleKey.E;

            Console.WriteLine($"\n\nВытянуть карту из колоды?\t{PressY} - вытянуть карту, {PressN} - пас, {PressE} - выйти из игры.");

            ConsoleKeyInfo charKey = Console.ReadKey(true);

            switch (charKey.Key)
            {
                case PressE:
                    _isPlaying = false;
                    break;

                case PressY:
                    DoTurn();
                    break;

                case PressN:
                    _player.BanTurn();
                    break;
                default:
                    Console.WriteLine("Ход пропущен");
                    break;
            }
        }

        private void SwitchScoreOverdone(Player player)
        {
            if (player._score > _scoreLimit)
            {
                player.BanTurn();

                player.TurnOnOverdoneStatus();
            }
        }

        private void PrintScore(Player player)
        {
            player.ShowHand();

            Console.WriteLine($"Очки {player.Name}: {player._score}");
        }

        private void GetResult()
        {
            if (_player.CanTakeCard == false && _enemy.CanTakeCard == false)
            {
                _isPlaying = false;

                Console.Clear();

                PrintScore(_player);

                PrintScore(_enemy);

                if (_player.IsScoreOverdone && _enemy.IsScoreOverdone)
                {
                    Console.WriteLine("Оба проиграли!");
                }
                else if (_player.IsScoreOverdone == false && _enemy.IsScoreOverdone == false  && _player._score > _enemy._score)
                {
                    Console.WriteLine($"Победитель - {_player.Name}!");
                }
                else if (_player.IsScoreOverdone == false && _enemy.IsScoreOverdone == false && _player._score < _enemy._score)
                {
                    Console.WriteLine($"Победитель - {_enemy.Name}!");
                }
                else if (_player.IsScoreOverdone == false && _enemy.IsScoreOverdone)
                {
                    Console.WriteLine($"Победитель - {_player.Name}!");
                }
                else if (_player.IsScoreOverdone && _enemy.IsScoreOverdone == false)
                {
                    Console.WriteLine($"Победитель - {_enemy.Name}!");
                }
                else if (_player.IsScoreOverdone == false && _enemy.IsScoreOverdone && _player._score == _enemy._score)
                {
                    Console.WriteLine($"Победитель - дружба. Ничья!");
                }

                Console.ReadKey(true);
            }
        }

        private void CalculateScore(Player player)
        {
            List<Card> hand = player.GetHand();

            int score = 0;

            for (int i = 0; i < hand.Count; i++)
            {
                score += _cardsValues[hand[i].Symbol];
            }

            player.SetScore(score);
        }
    }

    class Player
    {
        private List<Card> _cardsHand = new List<Card>();

        public Player()
        {
            Name = EnterName();
        }

        public Player(string name)
        {
            Name = name;
        }

        public int _score { get; private set; } = 0;
        public bool IsScoreOverdone { get; private set; } = false;
        public bool CanTakeCard { get; private set; } = true;
        public string Name { get; private set; }

        public void SetScore(int score)
        {
            _score = score;
        }

        public void TurnOnOverdoneStatus()
        {
            IsScoreOverdone = true;
        }

        public void BanTurn()
        {
            if (CanTakeCard)
            {
                CanTakeCard = false;
                Console.WriteLine($"{Name} завершил партию.");
                Console.ReadKey(true);
            }
        }

        public void ShowHand()
        {
            Console.Write($"\nKарты {Name}:\t");

            for (int i = 0; i < _cardsHand.Count; i++)
            {
                _cardsHand[i].Print();
            }
        }

        public void TakeCardToHand(Card card)
        {
            _cardsHand.Add(card);
        }

        public List<Card> GetHand()
        {
            List<Card> hand = _cardsHand.ToList();

            return hand;
        }

        private string EnterName()
        {
            string name = "";

            while (name == "")
            {
                Console.Write("Введите ваше имя: ");
                name = Console.ReadLine();
            }

            return name;
        }
    }

    class Deck36Cards
    {
        private List<Card> _cards;
        private string[] _cardNames;
        private Dictionary<char, ConsoleColor> _suitsColors;

        public Deck36Cards()
        {
            _cardNames = new string[] { "6", "7", "8", "9", "10", "J", "Q", "K", "A" };

            _suitsColors = new Dictionary<char, ConsoleColor>()
            {
                { '♥', ConsoleColor.DarkRed },
                { '♦', ConsoleColor.DarkRed },
                { '♠', ConsoleColor.DarkGray },
                { '♣', ConsoleColor.DarkGray },
            };

            _cards = Fill();
        }

        public List<Card> Mix()
        {
            List<Card> mixedDeck = new List<Card>();
            int cardsCount = _cards.Count;

            for (int i = 0; i < cardsCount; i++)
            {
                int randomIndex = UserUtils.GenerateRandomNumber(0, _cards.Count);

                mixedDeck.Add(_cards[randomIndex]);

                _cards.Remove(_cards[randomIndex]);
            }

            return mixedDeck;
        }

        private List<Card> Fill()
        {
            List<Card> cards = new List<Card>();

            foreach  (KeyValuePair<char, ConsoleColor> suits in _suitsColors)
            {
                for (int i = 0; i < _cardNames.Length; i++)
                {
                    cards.Add(new Card(_cardNames[i], suits.Key, suits.Value));
                }
            }

            return cards;
        }

        private void AddSuitLine(List<Card> cards, string name, char suit, ConsoleColor color)
        {
            cards.Add(new Card(name, suit, color));
        }
    }

    class Card
    {
        public Card(string cardSymbol, char cardSuit, ConsoleColor cardColor)
        {
            Symbol = cardSymbol;
            Suit = cardSuit;
            Color = cardColor;
        }

        public string Symbol { get; private set; }
        public char Suit { get; private set; }
        public ConsoleColor Color { get; private set; }

        public void Print()
        {
            Console.ForegroundColor = Color;
            Console.Write($"{Symbol}{Suit}  ");
            Console.ResetColor();
        }
    }

    class UserUtils
    {
        public static int GenerateRandomNumber(int min, int max)
        {
            Random random = new Random();
            int number = random.Next(min, max);
            return number;
        }
    }
}
