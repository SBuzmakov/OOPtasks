using System.Numerics;
using System.Reflection.Metadata.Ecma335;

namespace OOP4_CardDeck
{
    internal class Program
    {
        static void Main(string[] args)
        {
            Task task = new Task();

            task.StartTask();
        }  
    }

    class Task
    {
        private Deck36  _deck = new Deck36();
        private Player _player = new Player();
        private bool _isWork = true;

        public void StartTask()
        {
            while (_isWork)
            {
                _deck.Print();

                _player.ShowHand();

                Control();

                Console.Clear();
            }

            _player.ShowHand();
        }

        private void TakeCard()
        {
            if(_deck.CheckCardAvailability())
            {
                Card card = _deck.GetCard();

                _player.AddCardToHand(card);

                _deck.RemoveCard(card);
            }
            else
            {
                _isWork = false;
            }
        }

        private void Control()
        {
            const ConsoleKey PressY = ConsoleKey.Y;
            const ConsoleKey PressN = ConsoleKey.N;
            const ConsoleKey PressM = ConsoleKey.M;

            Console.WriteLine($"\n\nВытянуть карту из колоды?\t{PressY} - вытянуть карту, {PressN} - пас, {PressM} - перемешать колоду.");

            ConsoleKeyInfo charKey = Console.ReadKey(true);

            switch (charKey.Key)
            {
                case PressY:
                    TakeCard();
                    break;

                case PressN:
                    _isWork = false;
                    break;

                case PressM:
                    _deck.Mix();
                    break;

                default:
                    Console.WriteLine("Ход пропущен");
                    break;
            }
        }
    }

    class Player
    {
        private List<Card> _cardsHand = new List<Card>();

        public void ShowHand()
        {
            Console.Write($"\n взятые карты:\t");

            for (int i = 0; i < _cardsHand.Count; i++)
            {
                _cardsHand[i].Print();
            }
        }

        public void AddCardToHand(Card card)
        {
            _cardsHand.Add(card);
        }
    }

    class Deck36
    {
        private string[] _cardNames;
        private Dictionary<char, ConsoleColor> _suitsColors;
        private List<Card> _cards;

        public Deck36()
        {
            _cardNames = new string[] { "6", "7", "8", "9", "10", "J", "Q", "K", "A" };

            _suitsColors = new Dictionary<char, ConsoleColor>()
            {
                { '♥', ConsoleColor.DarkRed },
                { '♦', ConsoleColor.DarkRed },
                { '♠', ConsoleColor.DarkGray },
                { '♣', ConsoleColor.DarkGray },
            };

            _cards = Create();
        }

        public void Mix()
        {
            int cardsCount = _cards.Count;

            for (int i = 0; i < cardsCount; i++)
            {
                int randomIndex = UserUtils.GenerateRandomNumber(0, _cards.Count);

                Card temporaryCard = _cards[i];

                _cards[i] = _cards[randomIndex];

                _cards[randomIndex] = temporaryCard;
            }
        }

        public void Print()
        {
            for (int i = 0; i < _cards.Count; i++)
            {
                _cards[i].Print();
            }
        }
        public Card GetCard()
        {
            if (CheckCardAvailability())
            {
                return _cards[0];
            }
            else
            {
                return null;
            }
        }

        public bool CheckCardAvailability()
        {
            if (_cards.Count > 0)
            {
                return true;
            }
            else
            {
                Console.WriteLine("Карты в колоде закончились!");

                Console.ReadKey(true);

                return false;
            }
        }
        public void RemoveCard(Card card)
        {
            _cards.Remove(card);
        }

        private List<Card> Create()
        {
            List<Card> cards = new List<Card>();

            foreach  (KeyValuePair<char, ConsoleColor> suits in _suitsColors)
            {
                for (int i = 0; i < _cardNames.Length; i++)
                {
                    cards.Add(new Card(_cardNames[i], suits.Key, suits.Value));
                }
            }

            return cards;
        }
    }

    class Card
    {
        public Card(string cardSymbol, char cardSuit, ConsoleColor cardColor)
        {
            Symbol = cardSymbol;
            Suit = cardSuit;
            Color = cardColor;
        }

        public string Symbol { get; private set; }
        public char Suit { get; private set; }
        public ConsoleColor Color { get; private set; }

        public void Print()
        {
            Console.ForegroundColor = Color;
            Console.Write($"{Symbol}{Suit}  ");
            Console.ResetColor();
        }
    }

    class UserUtils
    {
        private static Random s_random = new Random();

        public static int GenerateRandomNumber(int min, int max)
        {
            return s_random.Next(min, max);
        }
    }
}
